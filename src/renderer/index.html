<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;">
  <title>Code Agent</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
  <link rel="stylesheet" href="styles.css">
  <script>
    // 确保 marked 和 hljs 在全局作用域
    window.marked = null;
    window.hljs = null;
  </script>
  <script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
  <!-- 工作目录选择界面 -->
  <div id="workDirSelect" class="work-dir-select">
    <!-- 顶部工具栏 -->
    <div class="work-dir-top-bar">
      <div class="work-dir-top-bar-drag"></div>
      <div class="work-dir-window-controls">
        <button id="workDirCloseBtn" class="window-control-btn close-btn" title="关闭">×</button>
      </div>
    </div>
    <div class="work-dir-content">
      <h1>Code Agent</h1>
      <p>请选择您的工作目录</p>
      <button id="selectDirBtn" class="select-dir-btn">选择工作目录</button>
      <div id="workDirRecentDirsList" class="work-dir-recent-dirs-list"></div>
    </div>
  </div>

  <!-- 主界面 -->
  <div id="mainApp" class="main-app" style="display: none;">
    <!-- 顶部工具栏 -->
    <div class="top-bar">
      <div class="top-bar-left">
        <button id="appTitleBtn" class="app-title-btn" title="返回工作目录选择">Code Agent</button>
      </div>
      <div class="top-bar-center">
        <div class="work-dir-container">
          <span id="workDirPath" class="work-dir-path"></span>
          <div class="recent-dirs-dropdown">
            <button id="recentDirsBtn" class="recent-dirs-btn" title="最近打开的项目">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <div id="recentDirsDropdown" class="recent-dirs-dropdown-menu" style="display: none;">
              <div id="recentDirsList" class="recent-dirs-list"></div>
            </div>
          </div>
          <button id="changeDirBtn" class="change-dir-btn" title="重新选择工作目录">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M3 7h5l2 2h11v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <path d="M3 7V5a2 2 0 0 1 2-2h6l2 2"></path>
              <path d="M13 13a4 4 0 1 0 4 4"></path>
              <path d="M17 17h3m0 0v-3"></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="top-bar-right">
        <button id="settingsBtn" class="settings-btn">⚙️</button>
        <div class="window-controls">
          <button id="minimizeBtn" class="window-control-btn minimize-btn" title="最小化">−</button>
          <button id="maximizeBtn" class="window-control-btn maximize-btn" title="最大化">□</button>
          <button id="closeBtn" class="window-control-btn close-btn" title="关闭">×</button>
        </div>
      </div>
    </div>

    <!-- 主内容区 -->
    <div class="main-content">
      <!-- 左侧会话列表 -->
      <div class="sidebar">
        <div class="sidebar-header">
          <h3>会话列表</h3>
          <button id="newSessionBtn" class="new-session-btn">+ 新建</button>
        </div>
        <div id="sessionList" class="session-list"></div>
      </div>

      <!-- 中间聊天区域 -->
      <div class="chat-area">
        <div class="context-progress">
          <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
          </div>
          <span id="progressText" class="progress-text">0 / 16384 tokens</span>
        </div>
        <div id="chatMessages" class="chat-messages"></div>
        <div id="welcomeScreen" class="welcome-screen">
          <div class="welcome-content">
            <h1 class="welcome-title">🤖 Code Agent</h1>
            <p class="welcome-description">欢迎使用 Code Agent！</p>
            <p class="welcome-hint">💬 您可以在下方输入框中对当前代码仓库进行提问</p>
            <p class="welcome-hint">✨ 我会帮助您理解代码、查找文件、分析问题等</p>
          </div>
        </div>
        <div id="statusBar" class="status-bar" style="display: none;">
          <div class="status-bar-content">
            <span class="status-bar-icon"></span>
            <span class="status-bar-text">准备中...</span>
          </div>
        </div>
        <div class="chat-input-area">
          <textarea id="chatInput" class="chat-input" placeholder="输入您的消息..."></textarea>
          <button id="sendBtn" class="send-btn">发送</button>
        </div>
      </div>

      <!-- 右侧Context面板 -->
      <div class="context-panel">
        <div class="context-header">
          <h3>Context 环境</h3>
        </div>
        <div class="context-content">
          <div class="context-card" data-module="thinking">
            <div class="context-card-header">
              <h4>🤔 AI思考</h4>
              <span class="context-card-toggle">▼</span>
            </div>
            <div class="context-card-body">
              <div id="thinkingContent" class="context-item"></div>
            </div>
          </div>
          <div class="context-card" data-module="planning">
            <div class="context-card-header">
              <h4>📋 TODO列表</h4>
              <span class="context-card-toggle">▼</span>
            </div>
            <div class="context-card-body">
              <div id="todoContent" class="context-item"></div>
            </div>
          </div>
          <div class="context-card" data-module="reflection">
            <div class="context-card-header">
              <h4>💭 反思过程</h4>
              <span class="context-card-toggle">▼</span>
            </div>
            <div class="context-card-body">
              <div id="reflectionContent" class="context-item"></div>
            </div>
          </div>
          <div class="context-card" data-module="codePool">
            <div class="context-card-header">
              <h4>💻 代码环境池</h4>
              <span class="context-card-toggle">▼</span>
            </div>
            <div class="context-card-body">
              <div id="codePoolContent" class="context-item"></div>
            </div>
          </div>
          <div class="context-card" data-module="memoPool">
            <div class="context-card-header">
              <h4>📝 备忘池</h4>
              <span class="context-card-toggle">▼</span>
            </div>
            <div class="context-card-body">
              <div id="memoPoolContent" class="context-item"></div>
            </div>
          </div>
          <div class="context-card" data-module="operationPool">
            <div class="context-card-header">
              <h4>🔧 操作池</h4>
              <span class="context-card-toggle">▼</span>
            </div>
            <div class="context-card-body">
              <div id="operationPoolContent" class="context-item"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 工具调用详情对话框 -->
  <div id="toolCallModal" class="tool-call-modal" style="display: none;">
    <div class="tool-call-modal-overlay"></div>
    <div class="tool-call-modal-content">
      <div class="tool-call-modal-header">
        <h3 id="toolCallModalTitle">工具调用详情</h3>
        <button class="tool-call-modal-close" id="toolCallModalClose">×</button>
      </div>
      <div class="tool-call-modal-body">
        <div class="tool-call-section">
          <div class="tool-call-section-title">调用参数</div>
          <div class="tool-call-card" id="toolCallModalArgs"></div>
        </div>
        <div class="tool-call-section">
          <div class="tool-call-section-title">执行结果</div>
          <div class="tool-call-card" id="toolCallModalResult"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 操作详情对话框 -->
  <div id="operationModal" class="operation-modal" style="display: none;">
    <div class="operation-modal-overlay"></div>
    <div class="operation-modal-content">
      <div class="operation-modal-header">
        <h3 id="operationModalTitle">操作详情</h3>
        <button class="operation-modal-close" id="operationModalClose">×</button>
      </div>
      <div class="operation-modal-body">
        <div class="operation-section">
          <div class="operation-section-title">工具调用ID</div>
          <div class="operation-id" id="operationModalId"></div>
        </div>
        <div class="operation-section">
          <div class="operation-section-title">调用参数</div>
          <div class="tool-call-card" id="operationModalArgs"></div>
        </div>
        <div class="operation-section">
          <div class="operation-section-title">执行结果</div>
          <div class="tool-call-card" id="operationModalResult"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="renderer.js"></script>
</body>
</html>
